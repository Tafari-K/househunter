{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% block content %}
<h1 class="visually-hidden">HouseHunters Blog</h1>
<div class="post-header">
    <div class="container">
        <div class="row">
            <div class="col-12">
                {% if post.featured_image and "placeholder" not in post.featured_image.url %}
                <img class="post-detail-image" src="{{ post.featured_image.url }}" alt="{{ post.title }}">
                {% else %}
                <img class="post-detail-image" src="{% static 'images/default.jpg' %}" alt="{{ post.title }}">
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="container post-detail-container">
    <div class="row">
        <div class="col-lg-10 offset-lg-1">
            <article class="post-content">
                <h1 class="post-title">{{ post.title }}</h1>

                <div class="post-meta">
                    <span class="post-author">
                        <i class="fas fa-user"></i> {{ post.author }}
                    </span>
                    <span class="post-date">
                        <i class="far fa-calendar-alt"></i> {{ post.created_on|date:"F d, Y" }}
                    </span>
                </div>

                <hr class="post-divider">

                {% if post.excerpt %}
                <div class="post-excerpt">
                    <p><em>{{ post.excerpt }}</em></p>
                </div>
                {% endif %}

                <div class="post-body">
                    {{ post.content | safe }}
                </div>

                <div class="back-link">
                    <a href="{% url 'home' %}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left"></i> Back to Blog
                    </a>
                </div>
            </article>
        </div>
    </div>
</div>

<div class="container comments-section">
    <div class="row">
        <div class="col-12">
            <h2 class="section-title">
                <i class="far fa-comments"></i> Comments ({{ comment_count }})
            </h2>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-12 col-lg-6">
            {% for comment in comments %}
            <div class="comment-item">
                <div class="comment-header">
                    <strong>{{ comment.author }}</strong>
                    <span class="comment-date">{{ comment.created_on|date:"M d, Y, g:i a" }}</span>
                </div>

                <div class="comment-body" id="comment{{ comment.id }}">
                    {{ comment.content }}
                </div>

                {% if not comment.approved %}
                <p class="comment-approval-notice">
                    <i class="fas fa-clock"></i> This comment is awaiting approval
                </p>
                {% endif %}

                {% if user.is_authenticated and comment.author == user %}
                <button type="button" class="btn btn-delete" 
                data-comment-id="{{ comment.id }}">
                Delete
                </button>
                <button type="button" class="btn btn-edit"
                    data-comment-id="{{ comment.id }}"
                    data-edit-url="{% url 'comment_edit' post.slug comment.id %}">
                    Edit
                </button>
                {% endif %}
            </div>
            {% empty %}
            <p class="no-comments">No comments yet. Be the first to comment!</p>
            {% endfor %}
        </div>

        <div class="col-12 col-lg-6">
            <h3 class="comment-form-title">
                <i class="fas fa-pen"></i> Leave a comment
            </h3>

            {% if user.is_authenticated %}
            <p class="posting-as">Posting as: <strong>{{ user.username }}</strong></p>

            <form id="commentForm" method="post" class="comment-form">
                {% csrf_token %}
                {{ comment_form|crispy }}
                <button id="submitButton" type="submit" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i> Submit Comment
                </button>
            </form>
            {% else %}
            <div class="login-prompt">
                <p><i class="fas fa-info-circle"></i> Please <a href="{% url 'account_login' %}">log in</a> to leave a comment.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="deleteModalLabel">Delete comment?</h4>
        <button type="button" class="btn-close"
          data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete your comment?
        This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary"
          data-bs-dismiss="modal">Close</button>
        <a id="deleteConfirm" href="#" class="btn btn-danger">Delete</a>
      </div>
    </div>
  </div>
</div>

{% endblock content %}

{% block extras %}
<script src="{% static 'js/comments.js' %}" defer></script>
{% endblock %}
